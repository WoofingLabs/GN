<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GN 隐私转账</title>
  <link rel="icon" href="https://raw.githubusercontent.com/WoofingLabs/Grabbit/refs/heads/main/images/GN.png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:1rem}
    .box{max-width:400px;width:100%;background:#111;border:1px solid #00d1ff30;border-radius:24px;padding:2rem;box-shadow:0 0 40px #00d1ff20}
    h1{font-size:2rem;text-align:center;margin:1rem 0;background:linear-gradient(135deg,#00d1ff,#8b00ff);-webkit-background-clip:text;color:transparent}
    input,button{width:100%;height:56px;border-radius:16px;margin:0.5rem 0;padding:0 1.2rem;font-size:1rem;outline:none}
    input{background:#000;border:1px solid #333;color:#fff}
    input:focus{border-color:#8b00ff}
    button{background:linear-gradient(135deg,#00d1ff,#8b00ff);border:none;color:#000;font-weight:800;cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .logo{width:80px;height:80px;border-radius:50%;box-shadow:0 0 30px #8b00ff;display:block;margin:0 auto 1rem}
    #log{text-align:center;margin-top:1rem;min-height:24px;font-size:0.9rem}
  </style>
</head>
<body>

<div class="box">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/refs/heads/main/images/GN.png" class="logo">
  <h1>GN 隐私转账</h1>
  <p style="text-align:center;color:#888;font-size:0.9rem">链上零痕迹 · 对方一键领</p>

  <button id="connect">连接钱包 (GateLayer)</button>

  <div id="form" style="display:none;margin-top:1rem">
    <input id="to" placeholder="对方钱包地址（0x...）">
    <input id="amt" placeholder="转账 GN 数量" type="number" step="0.000000000000000001">
    <button id="send">立即隐身转账</button>
    <button id="claim">我收到隐转 → 一键领取</button>
    <div id="log"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@noble/secp256k1@1.7.1/dist/index.min.js"></script>

<script>
const CONTRACT = "0x01c806771D5a9d3364683005Cc774c1eb3fdFA2b";
const ABI = [
  {"inputs":[{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stealthTransfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"_sender","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"},{"internalType":"uint8","name":"v","type":"uint8"}],"name":"claimStealth","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

let web3, account, contract;
const log = document.getElementById('log');

async function init() {
  if (!window.ethereum) return alert("请安装 MetaMask");
  await switchToGateLayer();
  document.getElementById("connect").onclick = connect;
}
async function switchToGateLayer() {
  try {
    await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2768'}]});
  } catch {
    await ethereum.request({method:'wallet_addEthereumChain', params:[{
      chainId:'0x2768', chainName:'GateLayer', rpcUrls:['https://gatelayer-mainnet.gatenode.cc'],
      nativeCurrency:{name:'GT',symbol:'GT',decimals:18}
    }]});
  }
}
async function connect() {
  const accs = await ethereum.request({method:'eth_requestAccounts'});
  account = accs[0];
  web3 = new Web3(ethereum);
  contract = new web3.eth.Contract(ABI, CONTRACT);
  document.getElementById("connect").innerHTML = `已连接 ${account.slice(0,6)}...`;
  document.getElementById("form").style.display = "block";
  document.getElementById("send").onclick = send;
  document.getElementById("claim").onclick = claim;
}

// 一键隐身转账
async function send() {
  const to = document.getElementById("to").value.trim();
  const amt = document.getElementById("amt").value;
  if (!web3.utils.isAddress(to)) return log.innerText = "无效地址";
  if (!amt || amt <= 0) return log.innerText = "输入金额";

  log.innerText = "生成隐身钥匙...";
  const ephemeralPriv = noble.utils.randomPrivateKey();
  const ephemeralPub = noble.getPublicKey(ephemeralPriv, false); // 65字节
  const stealthAddr = "0x" + Buffer.from(ephemeralPub.slice(1)).toString('hex').padStart(64,'0');

  const amountWei = web3.utils.toWei(amt, "ether");
  log.innerText = "发送隐身转账...";

  try {
    await contract.methods.stealthTransfer(
      stealthAddr,
      "0x" + Buffer.from(ephemeralPub).toString('hex'),
      amountWei
    ).send({from: account});

    // 保存本次转账记录到 localStorage（仅浏览器）
    const record = {sender:account, to, amount:amt, stealth:stealthAddr, ephPub:"0x"+Buffer.from(ephemeralPub).toString('hex'), ephPriv:"0x"+Buffer.from(epphermeralPriv).toString('hex')};
    let list = JSON.parse(localStorage.getItem("gn_stealth")||"[]");
    list.push(record);
    localStorage.setItem("gn_stealth", JSON.stringify(list));

    log.innerHTML = `隐身转账成功！<br>已通知对方可领取`;
    document.getElementById("amt").value = "";
  } catch(e) {
    log.innerText = "失败：" + (e.message||e);
  }
}

// 一键领取（自动扫描本地记录）
async function claim() {
  const list = JSON.parse(localStorage.getItem("gn_stealth")||"[]");
  if (list.length === 0) return log.innerText = "无待领记录";

  log.innerText = "正在领取所有...";
  for (let r of list) {
    try {
      const msg = web3.utils.soliditySha256(
        ["address","uint256","bytes32","bytes"],
        [r.sender, web3.utils.toWei(r.amount,"ether"), r.stealth, r.ephPub]
      );
      const hash = web3.utils.soliditySha256(
        ["string","bytes32"],
        ["\x19Ethereum Signed Message:\n32", msg]
      );
      const sig = noble.sign(hash.slice(2), r.ephPriv.slice(2));
      const rec = sig.recoveryParam;
      await contract.methods.claimStealth(
        r.sender,
        web3.utils.toWei(r.amount,"ether"),
        r.stealth,
        r.ephPub,
        "0x"+sig.slice(0,32).toString('hex'),
        "0x"+sig.slice(32,64).toString('hex'),
        rec + 27
      ).send({from: account});
      log.innerText += ` +${r.amount}GN`;
    } catch {}
  }
  log.innerText = "全部领取完成！";
  localStorage.setItem("gn_stealth", "[]");
}

init();
</script>
</body>
</html>
