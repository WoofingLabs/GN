<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>GN 隐私空投</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:1rem}
.c{max-width:380px;width:100%;background:#111;border:2px solid #00ff88;border-radius:25px;padding:30px;box-shadow:0 0 40px #00ff8850}
.logo{width:80px;height:80px;border-radius:50%;margin:0 auto 15px}
h1{font-size:26px;text-align:center;background:linear-gradient(90deg,#00ff88,#88ff00);-webkit-background-clip:text;color:transparent}
textarea{width:100%;padding:14px;margin:12px 0;border-radius:14px;background:#000;border:1px solid #333;color:#fff;font-size:14px}
button{width:100%;padding:16px;margin:10px 0;border:none;border-radius:14px;font-weight:900;font-size:16px;cursor:pointer;background:#00ff88;color:#000}
#log{color:#0f0;text-align:center;margin-top:15px;font-size:15px;line-height:1.6}
</style>
</head>
<body>
<div class="c">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/main/images/GN.png" class="logo">
  <h1>GN 隐私空投</h1>
  
  <textarea id="code" rows="3" placeholder="粘贴暗号">eyJzIjoiMHhGYjEwRTJiM0YyOTkzMWY4MzcyNjgwODc3ZjFlNGIzYTEzOUQ5RmEzIiwiYSI6Ijg1NTIiLCJ0IjoiMHgwNTgwYjFhODA2YjhmZDYxYjJjZGUxMTYxMjYzZTM1NGExYmU4ZThjMTQ5MGVkYjNlMzMwYjVjYTYzMGY3M2YwIiwicCI6IjB4MDI5Zjk2YTU3N2Y5NjI5NmI2ZWVkMTA4OTk4NDM4ZDU0MzI5MGZmNTEzNzE4YTI1YTRkMTFhMDY2YzdlOGJhZTdmIn0=</textarea>
  <button id="claim">我付 Gas 领 GN</button>
  <div id="log">粘贴暗号 → 点领取 → 3秒到账</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
<script>
const ADDR = '0x66106e442b5fF335BD7C2b7A3F3A9FCb18c62384';
const ABI = [{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"bytes","name":"","type":"bytes"},{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint8","name":"","type":"uint8"}],"name":"claimStealth","outputs":[],"stateMutability":"nonpayable","type":"function"}];

let web3, account, contract;
const log = document.getElementById('log');

async function init() {
  if (!window.ethereum) return log.innerHTML = '请安装 MetaMask';
  await ethereum.request({method:'eth_requestAccounts'});
  web3 = new Web3(window.ethereum);
  account = (await web3.eth.getAccounts())[0];
  contract = new web3.eth.Contract(ABI, ADDR);
  log.innerHTML = `已连接 <b>${account.slice(0,8)}...</b><br>点领取 → 3秒到账`;
}
init();

document.getElementById('claim').onclick = async () => {
  const input = document.getElementById('code').value.trim();
  if (!input) return log.innerHTML = '请粘贴暗号';
  let d;
  try { d = JSON.parse(atob(input)); } catch { return log.innerHTML = '暗号错误'; }

  log.innerHTML = '正在签名...';
  const msg = web3.utils.keccak256(
    web3.eth.abi.encodeParameters(
      ['address','uint256','bytes32','bytes'],
      [d.s, web3.utils.toWei(d.a,'ether'), d.t, d.p]
    )
  );

  const sig = await ethereum.request({method:'personal_sign', params:[msg, account]});
  const r = sig.slice(0,66);
  const s = '0x' + sig.slice(66,130);
  let v = parseInt(sig.slice(130,132),16);
  if (v < 27) v += 27;
  if (v > 30) v -= 1;  // 终极修复：v=28 变 27

  log.innerHTML = '正在领取代币...';
  try {
    await contract.methods.claimStealth(d.s, web3.utils.toWei(d.a,'ether'), d.t, d.p, r, s, v)
      .send({from: account, gas: 300000});
    log.innerHTML = `<span style="color:#88ff00">成功！+${d.a} GN 已到账</span>`;
  } catch (e) {
    log.innerHTML = '失败：' + (e.message || '请检查暗号');
  }
};
</script>
</body>
</html>
