<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>GN 隐私空投 · 发领一体</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:1rem}
.c{max-width:380px;width:100%;background:#111;border:2px solid #00ff88;border-radius:25px;padding:30px;box-shadow:0 0 40px #00ff8850}
.logo{width:80px;height:80px;border-radius:50%;margin:0 auto 15px;display:block}
h1{font-size:26px;text-align:center;background:linear-gradient(90deg,#00ff88,#88ff00);-webkit-background-clip:text;color:transparent}
input,button,textarea{width:100%;padding:14px;margin:10px 0;border-radius:14px;font-size:16px}
input,textarea{background:#000;border:1px solid #333;color:#fff;outline:none}
button{background:#00ff88;color:#000;font-weight:900;border:none;cursor:pointer;height:55px;transition:.3s}
button:hover{transform:scale(1.05)}
#log{color:#0f0;text-align:center;margin-top:10px;font-size:14px;line-height:1.6}
.hide{display:none}
#qrcode{text-align:center;margin:15px 0}
</style>
</head>
<body>
<div class="c">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/main/images/GN.png" class="logo">
  <h1>GN 隐私空投</h1>
  <button id="connect">连接钱包</button>

  <div id="main" class="hide">
    <input id="amt" placeholder="发多少 GN（整数）" type="number" min="1">
    <button id="send">发送 + 生成暗号</button>

    <div id="code" style="background:#222;padding:15px;border-radius:12px;margin:15px 0;display:none">
      <textarea id="dark" rows="3" readonly></textarea>
      <div id="qrcode"></div>
      <button onclick="copyDark()">复制暗号</button>
    </div>

    <textarea id="paste" rows="3" placeholder="粘贴暗号 → 我付 Gas 领 1000 GN"></textarea>
    <button id="claim">我付 Gas 领 GN</button>

    <div id="log">状态：等待连接</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
// ==================== 链配置 ====================
const CHAIN_ID = 10088;
const CHAIN_NAME = 'Gate Layer';
const RPC_URL = 'https://gatelayer-mainnet.gatenode.cc/';
const CURRENCY = { name: 'GT', symbol: 'GT', decimals: 18 };

// ==================== 合约信息 ====================
const CONTRACT_ADDR = '0xd7B7F2e8Ddb8AddbfAB284c74524f61A05c0740A';
const ABI = [
  {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"bytes32","name":"code","type":"bytes32"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes32","name":"code","type":"bytes32"}],"name":"drop","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"code","type":"bytes32"}],"name":"Drop","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
  {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"used","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
];

let web3, account, gn;
const $ = s => document.querySelector(s);
const log = $('#log');

// ==================== 切换/添加链 ====================
async function addOrSwitchChain() {
  const hex = '0x' + CHAIN_ID.toString(16);
  try {
    await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: hex }] });
  } catch (e) {
    if (e.code === 4902) {
      await ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: hex,
          chainName: CHAIN_NAME,
          rpcUrls: [RPC_URL],
          nativeCurrency: CURRENCY
        }]
      });
    } else throw e;
  }
}

// ==================== 连接钱包 ====================
async function connect() {
  if (!window.ethereum) return alert('请安装 MetaMask');
  await addOrSwitchChain();
  await ethereum.request({ method: 'eth_requestAccounts' });
  web3 = new Web3(window.ethereum);
  [account] = await web3.eth.getAccounts();
  gn = new web3.eth.Contract(ABI, CONTRACT_ADDR);

  $('#connect').innerHTML = `已连接 ${account.slice(0,6)}...${account.slice(-4)}`;
  $('#main').classList.remove('hide');
  log.innerText = '连接成功！可发可领';
}
$('#connect').onclick = connect;

// ==================== 生成随机 code ====================
function randomCode() {
  return '0x' + Array.from(crypto.getRandomValues(new Uint8Array(32)))
    .map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ==================== 发送空投 ====================
$('#send').onclick = async () => {
  const amt = $('#amt').value.trim();
  if (!amt || amt <= 0) return log.innerText = '请输入要发送的 GN 数量';
  const amount = web3.utils.toWei(amt, 'ether');
  log.innerText = '正在发送并生成暗号...';

  const code = randomCode();               // bytes32 code
  try {
    await gn.methods.drop(amount, code).send({ from: account });
    const dark = btoa(code);                // 只放 code，足够简单
    $('#dark').value = dark;
    $('#code').style.display = 'block';
    $('#qrcode').innerHTML = '';
    QRCode.toCanvas($('#qrcode'), dark, { width: 180, color: { dark: '#00ff88' } });
    log.innerHTML = `发送成功！已放入 ${amt} GN<br><span style="color:#88ff00">复制暗号发给朋友</span>`;
  } catch (e) {
    log.innerHTML = '发送失败：' + (e.message.split('\n')[0] || '检查余额/Gas');
  }
};

// ==================== 复制暗号 ====================
window.copyDark = () => {
  $('#dark').select();
  navigator.clipboard.writeText($('#dark').value);
  log.innerText = '暗号已复制！';
};

// ==================== 领取 ====================
$('#claim').onclick = async () => {
  const input = $('#paste').value.trim();
  if (!input) return log.innerText = '请粘贴暗号';
  let code;
  try { code = atob(input); } catch { return log.innerText = '暗号格式错误'; }
  if (!code.startsWith('0x') || code.length !== 66) return log.innerText = '暗号不合法';

  log.innerText = '正在领取 1000 GN...';
  try {
    await gn.methods.claim(code).send({ from: account });
    log.innerHTML = `<span style="color:#88ff00">领取成功！+1000 GN 已到账</span>`;
    $('#paste').value = '';
  } catch (e) {
    const msg = e.message.toLowerCase();
    if (msg.includes('already used')) log.innerHTML = '失败：暗号已被使用';
    else if (msg.includes('insufficient')) log.innerHTML = '失败：合约余额不足';
    else log.innerHTML = '领取失败：' + (msg.split('\n')[0] || '请检查暗号');
  }
};
</script>
</body>
</html>
