<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GN 隐私转账</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:1rem}
    .c{max-width:420px;width:100%;background:#111;border:2px solid #00d1ff;border-radius:28px;padding:2.5rem;box-shadow:0 0 60px #00d1ff40}
    .logo{width:100px;height:100px;border-radius:50%;box-shadow:0 0 50px #8b00ff;margin:0 auto 1rem;display:block}
    h1{font-size:2.4rem;text-align:center;background:linear-gradient(135deg,#00d1ff,#8b00ff);-webkit-background-clip:text;color:transparent}
    input,button,textarea{width:100%;border-radius:18px;margin:12px 0;padding:1rem;font-size:1.1rem}
    input,textarea{background:#000;border:1px solid #333;color:#fff;outline:none;resize:none}
    button{background:linear-gradient(135deg,#00d1ff,#8b00ff);border:none;color:#000;font-weight:900;cursor:pointer;height:60px}
    #log{text-align:center;margin-top:1rem;color:#0f0;font-size:1rem;line-height:1.5}
    .box{background:#222;padding:1rem;border-radius:12px;margin:1rem 0}
    .hide{display:none}
  </style>
</head>
<body>
<div class="c">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/refs/heads/main/images/GN.png" class="logo">
  <h1>GN 隐私转账</h1>
  <p style="text-align:center;color:#888">发钱出暗号 · 收钱粘暗号</p>

  <button id="connect">连接钱包</button>

  <div id="form" class="hide">
    <input id="to" placeholder="对方地址">
    <input id="amt" placeholder="GN 数量" type="number" step="any">
    <button id="send">隐身转账</button>
    
    <div id="code" class="box hide">
      <p><b>暗号（发给对方）：</b></p>
      <textarea id="dark" rows="3" readonly></textarea>
      <button onclick="copy()">复制暗号</button>
    </div>

    <hr style="border:1px solid #333;margin:2rem 0">

    <textarea id="paste" rows="3" placeholder="收钱人：粘贴暗号到这里"></textarea>
    <button id="claim">粘贴暗号 → 领取</button>

    <div id="log"></div>
  </div>
</div>

<!-- 你原来的钱包连接方式（100% 秒连） -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://unpkg.com/@noble/secp256k1@1.7.1"></script>

<script>
const CONTRACT = "0x13336e9d92eE3F7aBA8A5150A5DeB2FcD77EEB82";
const ABI = [ /* 两个函数 */ 
  {"inputs":[{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stealthTransfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"_sender","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},{"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"},{"internalType":"uint8","name":"v","type":"uint8"}],"name":"claimStealth","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

let web3, account, contract;
const log = document.getElementById('log');
const hex = a=>Array.from(a,b=>b.toString(16).padStart(2,'0')).join('');

// 你原来的连接方式（秒连）
document.getElementById('connect').onclick = async () => {
  if (!window.ethereum) return alert("请安装 MetaMask");
  web3 = new Web3(window.ethereum);
  await window.ethereum.request({ method: 'eth_requestAccounts' });
  account = (await web3.eth.getAccounts())[0];
  
  // 自动切链
  try { await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2768'}]}); }
  catch { await ethereum.request({method:'wallet_addEthereumChain', params:[{
      chainId:'0x2768', chainName:'GateLayer', rpcUrls:['https://gatelayer-mainnet.gatenode.cc'],
      nativeCurrency:{name:'GT',symbol:'GT',decimals:18}
  }]}); }

  contract = new web3.eth.Contract(ABI, CONTRACT);
  document.getElementById('connect').innerHTML = '已连接 ' + account.slice(0,8) + '...';
  document.getElementById('form').classList.remove('hide');
  document.getElementById('send').onclick = send;
  document.getElementById('claim').onclick = () => claimFromInput();
};

async function send() {
  const to = document.getElementById('to').value.trim();
  const amt = document.getElementById('amt').value;
  if (!web3.utils.isAddress(to)) return log.innerText = "地址错误";
  if (!amt || amt <= 0) return log.innerText = "输入金额";

  log.innerText = "生成暗号...";
  const ephPriv = noble.utils.randomPrivateKey();
  const ephPub = noble.getPublicKey(ephPriv, true);
  const stealth = "0x" + hex(ephPub.slice(1)).padStart(64,'0');
  const ephPubHex = "0x" + hex(ephPub);

  log.innerText = "请确认 gas...";
  try {
    await contract.methods.stealthTransfer(stealth, ephPubHex, web3.utils.toWei(amt,"ether")).send({from: account});
    const dark = btoa(JSON.stringify({sender:account, amt, stealth, ephPub:ephPubHex, ephPriv:"0x"+hex(ephPriv)}));
    document.getElementById('dark').value = dark;
    document.getElementById('code').classList.remove('hide');
    log.innerHTML = `成功！已转 ${amt} GN<br>把暗号发给对方`;
  } catch(e) { log.innerText = "失败：" + e.message; }
}

function copy() {
  document.getElementById('dark').select();
  navigator.clipboard.writeText(document.getElementById('dark').value);
  alert("暗号已复制！");
}

function claimFromInput() {
  const input = document.getElementById('paste').value.trim();
  if (!input) return log.innerText = "请粘贴暗号";
  try {
    const r = JSON.parse(atob(input));
    log.innerText = "请确认 gas...";
    const msg = web3.utils.keccak256(web3.utils.encodePacked(
      r.sender, web3.utils.toWei(r.amt,"ether"), r.stealth, r.ephPub
    ));
    const hash = web3.utils.keccak256(web3.utils.encodePacked("\x19Ethereum Signed Message:\n32", msg));
    const sig = noble.signSync(hash.slice(2), r.ephPriv.slice(2), {recovered: true});
    const [s, rec] = sig;

    contract.methods.claimStealth(
      r.sender, web3.utils.toWei(r.amt,"ether"), r.stealth, r.ephPub,
      "0x"+hex(s.slice(0,32)), "0x"+hex(s.slice(32,64)), rec + 27
    ).send({from: account})
    .then(() => { log.innerHTML = `领取成功！+${r.amt} GN 到账`; document.getElementById('paste').value = ''; })
    .catch(e => log.innerText = "领取失败：" + e.message);
  } catch { log.innerText = "暗号错误"; }
}
</script>
</body>
</html>
